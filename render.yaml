services:
  - type: web
    name: mechanics-shop-api
    runtime: python
    plan: free
    buildCommand: pip install -r requirements.txt
    preDeployCommand: |
      cd /opt/render/project/src && python -c "
      import os, sys, traceback
      sys.path.append('/opt/render/project/src')
      
      print('üöÄ Starting pre-deploy database setup...')
      
      try:
          from app import create_app, db
          from config import ProductionConfig
          
          app = create_app(ProductionConfig)
          
          with app.app_context():
              # Test database connection
              db.session.execute('SELECT 1')
              print('‚úÖ Database connection successful')
              
              # Create all tables
              db.create_all()
              print('‚úÖ Database tables created/verified')
              
              # List created tables
              from sqlalchemy import inspect
              inspector = inspect(db.engine)
              tables = inspector.get_table_names()
              print(f'üìã Found {len(tables)} tables: {tables}')
              
      except Exception as e:
          print(f'‚ùå Pre-deploy setup failed: {e}')
          traceback.print_exc()
          # Don't fail the deploy for database issues
          print('‚ö†Ô∏è Continuing deployment despite database issues...')
      "
    startCommand: gunicorn flask_app:app
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: mechanic_shop_db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: FLASK_ENV
        value: production